#!/bin/bash
# slx - SLurm eXtended
# A production-ready SLURM project manager
# Usage: slx <command> [options]

set -e

# Determine script location to find lib/
SLX_SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SLX_ROOT_DIR="$(cd "${SLX_SCRIPT_DIR}/.." && pwd)"
SLX_LIB_DIR="${SLX_ROOT_DIR}/lib/slx"
SLX_COMMANDS_DIR="${SLX_LIB_DIR}/commands"

# Source common functions
if [ -f "${SLX_LIB_DIR}/common.sh" ]; then
    source "${SLX_LIB_DIR}/common.sh"
else
    echo "Error: Could not find common.sh at ${SLX_LIB_DIR}/common.sh" >&2
    exit 1
fi

# Source all command files
for cmd_file in "${SLX_COMMANDS_DIR}"/*.sh; do
    if [ -f "$cmd_file" ]; then
        source "$cmd_file"
    fi
done

# ============================================
# Main command dispatcher
# ============================================

main() {
    # Load configuration
    load_config
    
    case "$1" in
        init)
            cmd_init
            ;;
        project)
            shift
            cmd_project "$@"
            ;;
        profile)
            shift
            cmd_profile "$@"
            ;;
        submit)
            shift
            submit_job "$@"
            ;;
        run)
            shift
            cmd_run "$@"
            ;;
        list)
            shift
            list_jobs "$@"
            ;;
        running)
            list_running
            ;;
        pending)
            list_pending
            ;;
        kill)
            shift
            kill_job "$@"
            ;;
        killall)
            killall_jobs
            ;;
        logs)
            shift
            view_logs "$@"
            ;;
        tail)
            shift
            tail_logs "$@"
            ;;
        info)
            shift
            show_info "$@"
            ;;
        status)
            show_status
            ;;
        history)
            shift
            show_history "$@"
            ;;
        find)
            shift
            find_jobs "$@"
            ;;
        clean)
            clean_logs
            ;;
        version|--version|-v)
            show_version
            ;;
        help|--help|-h)
            usage
            ;;
        "")
            usage
            ;;
        *)
            echo -e "${RED}Unknown command: $1${NC}"
            echo ""
            usage
            exit 1
            ;;
    esac
}

# Run main function
main "$@"
